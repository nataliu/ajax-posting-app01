 <%= form_for Post.new, :remote => true do |f| %>
   <div class="form-group">
     <%= f.text_area :content, :class => "form-control" %>
   </div>
   <div class="form-group">
     <%= f.submit :class => "btn btn-primary" %>
   </div>
 <% end %>

<div id="post-list">
  <% @posts.each do |post| %>
  <%= render :partial => "post", :locals => { :post => post } %>
  <% end %>
</div>

<script>
  // 这会绑click事件到所有有‘delete-post’ class到元素上，也就是所有的删除按钮
  $("#post-list").on('click', ".delete-post", function(evt){
    // 'evt'是浏览器的事件物件，evt.preventDefault(); 会终止这个元素的默认行为：
    evt.preventDefault();
    // this 是个特别的变量，代表触发事件的元素，使用attr可以读取元素的属性，这里要拿到超链接的网址。
    var url = $(this).attr("href");
    var that = this;

    // 送出ajax
    $.ajax({
      url: url,
      method: 'DELETE',
      dataType: ‘json’, //要求服务器回传json
      success: function(data) { // data 就是服务器回传的 json 资料
        $(that).closest(".panel").remove();
      }
    })
  })

  // 记下目前画面最小的贴文 id
  var current_post_id = <%= @posts.last.id %>;

  // 当卷轴动的时候，会触发这个事件
  $(window).scroll(function(){
    // 当卷到最下面的时候
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
      var url = "/posts?max_id=" + current_post_id;
      if (url){
        $.ajax({
          method: "GET",
          url: url,
          dataType: "script"
        })
      } else {
        console.log("data ended")
      }
    }
  })

 $("#post-list").on('change', ".toggle-flag", function(){
   var url = $(this).data("url");
   var that = this;

   $.ajax({
     url: url,
     method: "POST",
     dataType: "json",
     success: function(data){
       if ( data["flag_at"] ) {
         $(that).closest("label").find("span").html(data["flag_at"]);
       } else {
         $(that).closest("label").find("span").html("");
       }
     }
   });
 });

 $("#post-list").on('change', ".select_category", function(){
   var url = $(this).data("url");

   $.ajax({
     url: url,
     method: "PATCH",
     dataType: "json",
     data: {
       post: {
         category_id: $(this).val()
       }
     }
   })
 })

</script>
